# 🔒 黑屏隐私模式 - 功能规格说明

## 📋 功能概述

**目标：** 当 Android 设备被远程控制时，用户可以在 Android 设备本地开启"黑屏模式"，让设备屏幕显示黑色遮罩，防止旁人看到正在操作的内容。

**重要说明：** 这是 **Android 端自主控制** 的功能，不是 PC 端控制的。

---

## ✅ 理想实现效果

### 1️⃣ **界面位置**
```
┌─────────────────────────────────────────┐
│ RustDesk Android 应用                   │
├─────────────────────────────────────────┤
│ 📱 设备ID: 123456789                    │
│ 🔑 密码: xxxxxx                         │
├─────────────────────────────────────────┤
│ 权限                                    │
├─────────────────────────────────────────┤
│ [✓] 屏幕捕获                            │
│ [✓] 输入控制                            │
│ [✓] 传输文件                            │
│ [✓] 音频捕获                            │
│ [✓] 启用剪贴板                          │
│ [  ] 🔒 黑屏模式    ← 这里！            │
└─────────────────────────────────────────┘
```

### 2️⃣ **开启黑屏模式**

**用户操作：**
1. 用户在 Android 设备上打开 RustDesk 应用
2. 向下滚动到"权限"卡片
3. 点击"🔒 黑屏模式"开关

**系统行为（首次）：**
```
┌─────────────────────────────────────────┐
│ ⚠️ 需要悬浮窗权限                       │
├─────────────────────────────────────────┤
│ 黑屏模式需要在其他应用上层显示权限。    │
│ 点击确定后，请在设置页面中授予权限。    │
│                                         │
│           [确定]                        │
└─────────────────────────────────────────┘
        ↓ 点击确定后
┌─────────────────────────────────────────┐
│ 系统设置 - 显示在其他应用的上层         │
├─────────────────────────────────────────┤
│ 📱 应用列表                             │
│ ┌─────────────────────────────────────┐ │
│ │ RustDesk          [  关闭  ]  ← 点击 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [  开启  ] ← 切换为开启                 │
└─────────────────────────────────────────┘
        ↓ 授权后返回应用
        需要再次点击"黑屏模式"开关
```

**系统行为（已授权）：**
```
1. Toast 提示：🔒 黑屏模式已开启
2. Android 屏幕立即变黑
3. 显示白色提示文字：
   ┌─────────────────────────────────────────┐
   │                                         │
   │                                         │
   │         正在为您办理手续                 │
   │         请保持电量充足                   │
   │         勿操作手机                       │
   │                                         │
   │                                         │
   └─────────────────────────────────────────┘
4. 开关状态变为 [✓] 开启
```

### 3️⃣ **黑屏期间的行为**

| 视角 | 看到的内容 | 能做什么 |
|------|-----------|---------|
| **Android 设备屏幕** | 黑色遮罩 + 白色提示文字 | ❌ 无法触摸操作（被遮罩拦截）<br>❌ 无法看到真实屏幕内容 |
| **PC 端（远程控制）** | ✅ 正常显示 Android 真实屏幕 | ✅ 正常操作（鼠标、键盘、文件传输等）<br>✅ 完全不受黑屏影响 |

**技术实现：**
- Android 系统的屏幕内容 → 正常捕获 → 传输到 PC 端
- Android 本地显示层 → 叠加黑色遮罩 → 用户看到黑屏
- 屏幕捕获在遮罩层之下，不受影响

### 4️⃣ **关闭黑屏模式**

**用户操作：**
1. 用户需要先下拉通知栏
2. 点击"系统服务"通知（PrivacyModeService 创建的）
3. 会返回 RustDesk 应用
4. 点击"🔒 黑屏模式"开关关闭

**系统行为：**
```
1. Toast 提示：👁️ 黑屏模式已关闭
2. 黑色遮罩立即消失
3. Android 屏幕恢复正常显示
4. 开关状态变为 [  ] 关闭
```

---

## 🎯 使用场景

### 场景 1：远程办理银行业务
```
用户张三需要远程帮助父母办理银行 APP 操作：
1. 父母打开 RustDesk，告诉张三设备 ID
2. 张三用 PC 连接到父母的手机
3. 父母在手机上开启"黑屏模式"
4. 父母的手机屏幕变黑，周围人看不到操作内容
5. 张三在 PC 上看到正常屏幕，帮助完成银行操作
6. 完成后，父母关闭黑屏模式
```

### 场景 2：技术支持
```
IT 人员远程协助同事解决软件问题：
1. 同事打开 RustDesk 并开启黑屏模式
2. 同事可以离开座位喝咖啡，不担心屏幕被看到
3. IT 人员在远程看到正常屏幕，排查问题
4. 完成后发消息告知同事
5. 同事回来关闭黑屏模式
```

---

## 🔐 权限要求

### 必需权限
- **悬浮窗权限** (`SYSTEM_ALERT_WINDOW`)
  - Android 6.0+ 必须手动授予
  - 用于在所有应用上层显示黑色遮罩
  - 首次点击开关时会自动跳转到设置页面

### 权限检查流程
```
用户点击开关
    ↓
检查 Android 版本
    ↓
≥ Android 6.0?
    ├─ 是 → 检查悬浮窗权限
    │       ├─ 已授予 → 开启黑屏
    │       └─ 未授予 → 跳转到设置页面
    └─ 否 → 直接开启黑屏（旧版本不需要权限）
```

---

## 🧩 技术实现

### 架构图
```
Flutter UI (server_page.dart)
    │ 权限卡片
    │ [  ] 🔒 黑屏模式 ← 用户点击
    ↓
_togglePrivacyMode()
    │ 1. 防抖检查 (_privacyModeLoading)
    │ 2. 计算新状态 (!_privacyModeOn)
    ↓
gFFI.invokeMethod('set_by_name', ...)
    │ Flutter → Kotlin 跨平台调用
    ↓
MainActivity.kt
    │ 1. 检查悬浮窗权限
    │ 2. 调用 PrivacyModeService
    ↓
PrivacyModeService.kt
    │ 1. 创建前台通知
    │ 2. 创建黑色遮罩 View
    │ 3. 添加到 WindowManager
    ↓
Android 系统显示黑屏
```

### 核心代码位置

| 文件 | 作用 | 关键函数 |
|------|------|---------|
| `flutter/lib/mobile/pages/server_page.dart` | Flutter UI 层 | `_togglePrivacyMode()` |
| `flutter/android/.../MainActivity.kt` | Flutter → Native 桥接 | `set_by_name` case `toggle_privacy_mode` |
| `flutter/android/.../PrivacyModeService.kt` | 黑屏服务实现 | `startPrivacyMode()`, `createBlackOverlay()` |

---

## ✅ 功能测试清单

### 基础功能
- [ ] 1. 开关出现在权限卡片中
- [ ] 2. 开关样式和其他权限一致
- [ ] 3. 点击开关有响应（不是点击即返回）
- [ ] 4. 开启后有 Toast 提示："🔒 黑屏模式已开启"
- [ ] 5. 关闭后有 Toast 提示："👁️ 黑屏模式已关闭"

### 黑屏效果
- [ ] 6. 开启后 Android 屏幕立即变黑
- [ ] 7. 黑屏上显示白色提示文字
- [ ] 8. 黑屏期间无法触摸操作
- [ ] 9. 关闭后黑屏立即消失
- [ ] 10. 屏幕恢复正常显示和操作

### 远程控制
- [ ] 11. PC 连接 Android 设备
- [ ] 12. Android 开启黑屏后，PC 端仍显示正常屏幕
- [ ] 13. PC 端可以正常操作（鼠标、键盘）
- [ ] 14. PC 端可以正常看到屏幕变化
- [ ] 15. 文件传输功能不受影响

### 权限处理
- [ ] 16. 首次点击开关会检查权限
- [ ] 17. 没有权限时跳转到设置页面
- [ ] 18. Toast 提示："⚠️ 需要悬浮窗权限..."
- [ ] 19. 授权后再次点击开关能成功开启
- [ ] 20. Android 6.0 以下直接开启（不检查权限）

### 错误处理
- [ ] 21. 权限被拒绝时，开关保持关闭状态
- [ ] 22. 服务启动失败时，显示错误提示
- [ ] 23. 多次快速点击开关不会崩溃（防抖）
- [ ] 24. 应用崩溃后重启，黑屏自动清除

### 日志验证
- [ ] 25. `DEBUG_PRIVACY: 权限卡片尝试切换黑屏模式`
- [ ] 26. `DEBUG_PRIVACY: toggle_privacy_mode 开始`
- [ ] 27. `DEBUG_PRIVACY: PrivacyModeService onCreate called`
- [ ] 28. `DEBUG_PRIVACY: Black overlay created successfully`
- [ ] 29. `DEBUG_PRIVACY: 黑屏模式切换成功`

---

## 🐛 常见问题排查

### 问题 1：点击开关没反应
**可能原因：**
- Flutter 代码编译失败
- `gFFI.invokeMethod` 调用失败

**排查步骤：**
```bash
# 查看 Flutter 日志
adb logcat | Select-String "DEBUG_PRIVACY"

# 应该看到：
DEBUG_PRIVACY: 权限卡片尝试切换黑屏模式: 当前状态=false, 目标状态=true
```

### 问题 2：黑屏没有出现
**可能原因：**
- 悬浮窗权限未授予
- PrivacyModeService 启动失败

**排查步骤：**
```bash
# 查看服务启动日志
adb logcat | Select-String "PrivacyModeService"

# 检查权限
adb shell dumpsys package com.carriez.flutter_hbb | Select-String "SYSTEM_ALERT_WINDOW"
```

### 问题 3：PC 端也看到黑屏
**分析：** 这不应该发生！黑屏遮罩只是在 Android 本地显示层叠加的，不影响底层屏幕捕获。

**可能原因：**
- 屏幕捕获服务被黑屏遮罩阻挡（实现错误）

**正确实现：**
```
WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY  ← 正确的窗口类型
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE        ← 不抢占焦点
```

---

## 📊 性能指标

| 指标 | 目标值 | 说明 |
|------|-------|------|
| 黑屏响应时间 | < 500ms | 从点击开关到屏幕变黑 |
| 内存占用 | < 5MB | PrivacyModeService 运行时 |
| CPU 占用 | < 1% | 黑屏显示时的 CPU 使用 |
| 电量影响 | 可忽略 | 静态黑屏不应该耗电 |

---

## 🚀 未来改进方向

### 功能增强
1. **自定义黑屏文字**
   - 允许用户设置自定义提示文字
   - 例如："维护中，请稍候"、"系统升级中"

2. **定时自动关闭**
   - 设置黑屏持续时间（如 30 分钟后自动关闭）
   - 防止用户忘记关闭

3. **快捷磁贴**
   - 在通知栏快速设置中添加黑屏开关
   - 不需要打开 APP 就能切换

4. **黑屏主题**
   - 纯黑屏（当前）
   - 伪装成锁屏界面
   - 伪装成系统更新页面

### 技术优化
1. **状态持久化**
   - 应用重启后记住黑屏状态
   - 如果之前是开启的，重启后自动恢复

2. **更智能的权限引导**
   - 首次使用时主动提示授权
   - 一键授权流程（减少步骤）

3. **更好的错误提示**
   - 区分不同类型的错误
   - 提供具体的解决方案链接

---

## 📝 总结

这个"黑屏模式"功能完美实现了：
- ✅ Android 端用户自主控制
- ✅ 简单直观的开关操作
- ✅ 和其他权限一致的 UI 风格
- ✅ 完善的错误处理和用户提示
- ✅ 不影响 PC 端的远程控制体验
- ✅ 充分的日志记录便于调试

**理想效果：** 点击开关 → 屏幕变黑 → 旁人看不到 → PC 照常操作 → 再次点击 → 恢复正常 🎯
